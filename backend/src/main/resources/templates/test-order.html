<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>BoothEat 주문 테스트</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        button { padding: 8px 16px; margin: 4px; cursor: pointer; }
        button[disabled] { opacity: .5; cursor: not-allowed; }
        input { padding: 6px; }
        .row { display: flex; gap: 16px; flex-wrap: wrap; }
        .box { border: 1px solid #ddd; padding: 12px; margin-top: 12px; border-radius: 8px; flex: 1; min-width: 320px; }
        pre { background: #f8f8f8; padding: 8px; white-space: pre-wrap; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border:1px solid #ddd; padding:6px; text-align:left; }
        th { background:#fafafa; }
        .muted { color:#777; }
        .error { color:#b00020; }
        .ok { color:#0a7f2e; }
    </style>
</head>
<body>
<h1>BoothEat 주문 테스트 페이지</h1>

<div class="box">
    <h3>대상 테이블</h3>
    <label>부스 ID: <input type="number" id="boothId" value="1" min="1"></label>
    <label>테이블 번호: <input type="number" id="tableNo" value="1" min="1"></label>
    <button id="btn-refresh" onclick="refreshContext()">컨텍스트 새로고침</button>
    <button id="btn-close" onclick="closeVisit()">방문 종료(close-visit)</button>
    <div id="ctx" class="muted" style="margin-top:8px;">컨텍스트 로드 전</div>
</div>

<div class="row">
    <div class="box">
        <h3>1. 주문 생성</h3>
        <p class="muted">빠른 주문: (메뉴 1)핫도그×2 + (메뉴 3)콜라×1 = 10,000원</p>
        <button id="btn-quick" onclick="createQuick()">빠른 주문 생성</button>

        <details style="margin-top:8px;">
            <summary>임의 주문 생성 (메뉴ID/수량 지정)</summary>
            <div>
                <label>메뉴1 ID: <input type="number" id="menu1" value="1" min="1"></label>
                <label>수량: <input type="number" id="qty1" value="1" min="1"></label>
            </div>
            <div>
                <label>메뉴2 ID: <input type="number" id="menu2" value="" min="1" placeholder="선택"></label>
                <label>수량: <input type="number" id="qty2" value="1" min="1"></label>
            </div>
            <div>
                <label>입금자명: <input type="text" id="payer" value="테스트손님"></label>
                <label>금액: <input type="number" id="amount" value="10000" min="0"></label>
            </div>
            <button id="btn-create" onclick="createCustom()">임의 주문 생성</button>
        </details>

        <div id="create-res" class="muted" style="margin-top:8px;">-</div>
    </div>

    <div class="box">
        <h3>2. 주문 조회</h3>
        <label>Order ID: <input type="number" id="orderId" min="1"></label>
        <button id="btn-get" onclick="getOrder()">조회</button>
        <pre id="order-res">-</pre>
    </div>

    <div class="box">
        <h3>3. 주문 승인</h3>
        <label>Order ID: <input type="number" id="approveOrderId" min="1"></label>
        <button id="btn-approve" onclick="approveOrder()">승인</button>
        <div id="approve-res" class="muted">-</div>
    </div>
</div>

<div class="box">
    <h3>최근 주문 10건</h3>
    <table id="orders-table">
        <thead>
        <tr>
            <th>Order ID</th><th>Order Code</th><th>Status</th>
            <th>Total</th><th>CreatedAt</th><th>ApprovedAt</th><th>VisitId</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<script th:inline="javascript">
    const ctx = /*[[@{/}]]*/ '/';
    const q = id => document.getElementById(id);
    const val = id => q(id).value;
    const fmt = x => x==null?'-':x;
    const money = n => Number(n).toLocaleString('ko-KR');
    const disable = (id, on) => q(id).disabled = !!on;

    async function refreshContext(){
        try {
            disable('btn-refresh', true);
            const boothId = val('boothId'), tableNo = val('tableNo');
            const r = await fetch(`${ctx}api/dev/table-context?boothId=${boothId}&tableNo=${tableNo}`);
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            const data = await r.json();

            // visit
            let visitHtml = '<div class="muted">OPEN visit 없음</div>';
            if (data.currentVisit){
                const v = data.currentVisit;
                visitHtml = `
          <div><b>visitId:</b> ${v.visitId}, <b>visitNo:</b> ${v.visitNo},
          <b>status:</b> ${v.status}</div>
          <div><b>startedAt:</b> ${v.startedAt}, <b>closedAt:</b> ${fmt(v.closedAt)}</div>
        `;
            }
            q('ctx').innerHTML = visitHtml;

            // recent orders
            const tbody = document.querySelector('#orders-table tbody');
            tbody.innerHTML = '';
            (data.recentOrders || []).forEach(o => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${o.orderId}</td>
          <td>${o.orderCode}</td>
          <td>${o.status}</td>
          <td>${money(o.totalAmount)}</td>
          <td>${o.createdAt}</td>
          <td>${fmt(o.approvedAt)}</td>
          <td>${o.visitId}</td>
        `;
                tbody.appendChild(tr);
            });
        } catch(e) {
            q('ctx').innerHTML = `<span class="error">컨텍스트 로드 실패: ${e.message}</span>`;
        } finally {
            disable('btn-refresh', false);
        }
    }

    async function createQuick(){
        await createOrderPayload({
            items: [{menuItemId:1, quantity:2}, {menuItemId:3, quantity:1}],
            payerName: '테스트손님',
            amount: 10000
        });
    }

    async function createCustom(){
        const items = [];
        const m1 = Number(val('menu1')), q1 = Number(val('qty1'));
        if (m1 && q1>0) items.push({menuItemId:m1, quantity:q1});
        const m2 = Number(val('menu2')), q2 = Number(val('qty2'));
        if (m2 && q2>0) items.push({menuItemId:m2, quantity:q2});
        if (items.length === 0) { q('create-res').innerHTML = '<span class="error">메뉴를 1개 이상 입력하세요.</span>'; return; }

        await createOrderPayload({
            items,
            payerName: val('payer') || '손님',
            amount: Number(val('amount')||0)
        });
    }

    async function createOrderPayload({items, payerName, amount}){
        try {
            disable('btn-quick', true); disable('btn-create', true);
            const boothId = Number(val('boothId')), tableNo = Number(val('tableNo'));
            const body = { boothId, tableNo, items, payment: { payerName, amount } };
            const r = await fetch(`${ctx}api/orders`, {
                method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)
            });
            if (!r.ok) {
                const txt = await r.text();
                throw new Error(`HTTP ${r.status} - ${txt}`);
            }
            const data = await r.json();
            q('create-res').innerHTML = `<span class="ok">주문 생성: #${data.orderId} (${data.orderCode}) ${data.status}, ${money(data.totalAmount)}원</span>`;
            q('orderId').value = data.orderId;
            q('approveOrderId').value = data.orderId;
            await refreshContext();
        } catch(e) {
            q('create-res').innerHTML = `<span class="error">주문 실패: ${e.message}</span>`;
        } finally {
            disable('btn-quick', false); disable('btn-create', false);
        }
    }

    async function getOrder(){
        try {
            disable('btn-get', true);
            const id = val('orderId');
            const r = await fetch(`${ctx}api/orders/${id}`);
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            const data = await r.json();
            q('order-res').textContent = JSON.stringify(data, null, 2);
            await refreshContext();
        } catch(e) {
            q('order-res').textContent = '조회 실패: ' + e.message;
        } finally {
            disable('btn-get', false);
        }
    }

    async function approveOrder(){
        try {
            disable('btn-approve', true);
            const id = val('approveOrderId');
            const r = await fetch(`${ctx}api/manager/orders/${id}/approve`, { method:'POST' });
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            q('approve-res').innerHTML = `<span class="ok">Order ${id} 승인 완료</span>`;
            await getOrder();
        } catch(e) {
            q('approve-res').innerHTML = `<span class="error">승인 실패: ${e.message}</span>`;
        } finally {
            disable('btn-approve', false);
        }
    }

    async function closeVisit(){
        try {
            disable('btn-close', true);
            const boothId = val('boothId'), tableNo = val('tableNo');
            const r = await fetch(`${ctx}api/manager/tables/${boothId}/${tableNo}/close-visit`, { method:'POST' });
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            alert('현재 OPEN visit 종료됨');
            await refreshContext();
        } catch(e) {
            alert('종료 실패: ' + e.message);
        } finally {
            disable('btn-close', false);
        }
    }

    async function finishOrder(){
        const id = document.getElementById('approveOrderId').value;
        const r = await fetch(`/api/manager/orders/${id}/finish`, { method:'POST' });
        if (r.ok){ alert(`Order ${id} FINISHED`); await getOrder(); }
        else { alert('완료 실패: HTTP ' + r.status); }
    }

    // 초기 로드
    refreshContext().catch(console.error);
</script>
</body>
</html>
